XpV0(
    project: "dcc",
    containers: {
        "trainer": (
            command: ["python", "main.py"],
            env_secrets: {
                "WANDB_API_KEY": "wandb-api-key",
            },
            gpu: 1,
            gpu_mem: "5GB",
            volumes: {
                "/mnt/a/Dropbox/artifacts/xprun": "/mnt/xprun",
            },
            build: [
                BaseImage("nvcr.io/nvidia/pytorch:21.03-py3"),
                Repo(path: "requirements.txt"),
                Run("pip install -r requirements.txt"),
                Repo(keep: true, cd: true),
            ],
        ),
        "codecraftserver": (
            command: ["sbt", "run"],
            tty: true,
            env: {
                "SBT_OPTS": "-Xmx15G",
            },
            build: [
                BaseImage("hseeberger/scala-sbt:8u222_1.3.5_2.13.1"),

                // build fixed versions of CodeCraftGame and CodeCraftServer as a straightforward way to download sbt 0.13.16 and populate dependency cache
                Repo(url: "https://github.com/cswinter/CodeCraftGame.git", rev: "92304eb", cd: true),
                Run("sbt publishLocal"),
                Repo(url: "https://github.com/cswinter/CodeCraftServer.git", rev: "df76892", cd: true),
                Run("sbt compile"),

                // build CodeCraftGame and CodeCraftServer from source
                Repo(url: "https://github.com/cswinter/CodeCraftGame.git", rev: "3da8367", cd: true),
                Run("sbt publishLocal"),
                Repo(url: "https://github.com/cswinter/CodeCraftServer.git", rev: "db01b4d", keep: true, cd: true),
                Run("sbt compile"),
            ],
        ),
    }
)
